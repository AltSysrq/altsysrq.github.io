<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Installation Guide - Crymap</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Usage documentation for the Crymap IMAP server">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'visible';
            if (document.body.clientWidth < 500) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="encryption.html"><strong aria-hidden="true">1.</strong> How Crymap's Encryption Works</a></li><li class="chapter-item expanded "><a href="installation-guide.html" class="active"><strong aria-hidden="true">2.</strong> Installation Guide</a></li><li class="chapter-item expanded "><a href="admin-guide/index.html"><strong aria-hidden="true">3.</strong> Administration Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="admin-guide/config.html"><strong aria-hidden="true">3.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="admin-guide/users.html"><strong aria-hidden="true">3.2.</strong> Managing Users</a></li><li class="chapter-item expanded "><a href="admin-guide/backups.html"><strong aria-hidden="true">3.3.</strong> Backups and Recovery</a></li><li class="chapter-item expanded "><a href="admin-guide/filesystem.html"><strong aria-hidden="true">3.4.</strong> Understanding the Filesystem</a></li><li class="chapter-item expanded "><a href="admin-guide/tuning.html"><strong aria-hidden="true">3.5.</strong> Tuning</a></li><li class="chapter-item expanded "><a href="admin-guide/migration.html"><strong aria-hidden="true">3.6.</strong> Migration from Crymap 1.x</a></li></ol></li><li class="chapter-item expanded "><a href="user-guide.html"><strong aria-hidden="true">4.</strong> User Guide</a></li><li class="chapter-item expanded "><a href="imap.html"><strong aria-hidden="true">5.</strong> IMAP Characteristics</a></li><li class="chapter-item expanded "><a href="smtp.html"><strong aria-hidden="true">6.</strong> SMTP/LMTP Characteristics</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>

                        <h1 class="menu-title">Crymap</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="installation-guide"><a class="header" href="#installation-guide">Installation Guide</a></h1>
<h2 id="system-requirements"><a class="header" href="#system-requirements">System Requirements</a></h2>
<p>Crymap is designed to run on FreeBSD and Linux. It probably works on the other
BSDs, but is not tested on them. Windows is not supported and most likely never
will be since its filesystem is incompatible with Crymap’s requirements on many
fronts.</p>
<p>The host file system must support symlinks and hard links. There must not be
mount points inside any user directory. Remote file systems like NFS are
supported if they provide sufficient consistency guarantees, but Crymap is not
specifically designed to work with them, and IDLE notifications will only work
properly if all Crymap instances for a given user are run on the same host.</p>
<p>When run on a single-CPU host or with appropriate tuning on a multi-CPU host,
each Crymap instance typically only consumes a few MB of RAM. However, do be
aware that Crymap is a one-process-per-connection system.</p>
<p>Crymap generally only holds at most a few dozen file handles open at any given
time.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>Crymap requires having the OpenSSL libraries installed. On Debian/Ubuntu, you
can get them with <code>apt install openssl</code>. FreeBSD has the required libraries in
the base distribution. (There is a way to cause OpenSSL to be built along with
Crymap and statically linked, but this is not recommended since you won’t be
able to get OpenSSL updates with your OS and this process is not described in
this manual.)</p>
<p>Each [https://github.com/AltSysrq/crymap/releases/](release of Crymap) has
pre-built binaries for AMD64 Debian and FreeBSD. Simply download the
appropriate one of these and save it in a place you consider appropriate; for
example (<code>#</code> means “as root”):</p>
<pre><code class="language-text"># cp crymap-$version-$os-amd64 /usr/local/bin/crymap
# chmod a=rx /usr/local/bin/crymap
</code></pre>
<p>If you do not want to use the pre-built binary or need to run on a different OS
or architecture, you need to build Crymap from source. This requires having
Rust installed, which you can get through
<a href="https://github.com/rust-lang/rustup/#other-installation-methods">rustup</a>.</p>
<p>The easiest way to build Crymap is to get it with <code>cargo</code>:</p>
<pre><code class="language-text">$ cargo install crymap
# cp ~yourusername/.cargo/bin/crymap /usr/local/bin/crymap
</code></pre>
<p>You can also clone the repository directly:</p>
<pre><code class="language-text">$ git clone git@github.com:altsysrq/crymap
$ cd crymap
$ cargo build --release
# cp target/release/crymap /usr/local/bin/crymap
</code></pre>
<h2 id="initial-system-setup"><a class="header" href="#initial-system-setup">Initial System Setup</a></h2>
<p>First, make sure you have valid SSL certificates for your domain. A full
explanation of how to do this is beyond the scope of this document, but
<a href="https://letsencrypt.org/">Let’s Encrypt</a> is a good place to start if you are
new to this.</p>
<p>All files used by Crymap are reachable from (though not necessarily “in”) a
directory referred to as the “Crymap root”. By default, this is either
<code>/etc/crymap</code> or <code>/usr/local/etc/crymap</code> (whichever exists); you can use
something else, but if you do so, you must pass <code>--root</code> to all <code>crymap server</code>
commands to tell Crymap where its data is. For this tutorial, we’ll use
<code>/usr/local/etc/crymap</code> as the root.</p>
<p>Start by creating the Crymap root directory. The files we’re setting up below
shouldn’t be modified in normal operation, so they should be owned by <code>root</code>.</p>
<pre><code class="language-text"># mkdir /usr/local/etc/crymap
</code></pre>
<p>Next, we create Crymap’s system configuration file, which is a file named
<code>crymap.toml</code> under the Crymap root. A minimal configuration example is shown
below.</p>
<pre><code class="language-toml"># /usr/local/etc/crymap/crymap.toml
[tls]
# The path to your X509 private key. The example here would be correct for
# a FreeBSD system at `example.org` using Let's Encrypt with the default
# configuration.
private_key = "/usr/local/etc/letsencrypt/live/example.org/privkey.pem"
# The path to the full X509 certificate chain.
certificate_chain = "/usr/local/etc/letsencrypt/live/example.org/fullchain.pem"
</code></pre>
<p>(Yes, that’s all there is to the required configuration.)</p>
<p>Before we go further, we need to decide what style of deployment we’re going to
do. Crymap supports three general patterns:</p>
<ul>
<li>
<p>UNIX-style deployment, in which each Crymap user corresponds to a UNIX user
on the host system and owns their Crymap files.</p>
</li>
<li>
<p>Simple black box deployment, where Crymap users are unrelated to UNIX users,
and all Crymap data is owned by a dedicated UNIX account. Crymap is always
run under that UNIX account.</p>
</li>
<li>
<p>Two-step black box deployment. As above, but Crymap is run as <code>root</code> and then
allowed to drop privileges once it no longer needs them. This requires more
work to set up but means that the dedicated Crymap user doesn’t need
permission to read SSL certificates and the like. This chapter won’t talk
about this approach; simply go through the setup for the simple black box
deployment, then refer to <a href="admin-guide/config.html">the configuration
reference</a> to see what to change.</p>
</li>
</ul>
<p>If doing a black box deployment, set up the dedicated Crymap user now. Below,
we’ll assume the user has name <code>crymap</code> and group <code>mail</code>, but of course that
will vary with your system.</p>
<p>The next step is to create the <code>users</code> directory.</p>
<p>If doing a UNIX-style deployment, the user’s mail will typically be stored in
their home directory. This means that <code>users</code> will not actually contain the
data and we can just make it a normal directory.</p>
<pre><code class="language-text"># mkdir /usr/local/etc/crymap/users
</code></pre>
<p>On a black-box deployment, the user data will end up under whatever directory
we create, and we don’t really want to be storing data under <code>/etc</code>. Thus, we
will create the <code>users</code> directory elsewhere and symlink it from the nominal
location. In this example, we store users under <code>/srv/crymap-users</code>.</p>
<pre><code class="language-text"># mkdir -m 750 /srv/crymap-users
# chown crymap:mail /srv/crymap-users
# ln -s /srv/crymap-users /usr/local/etc/crymap/users
</code></pre>
<p>To see if your configuration so far is good, try running <code>crymap serve serve-imaps</code> under the same UNIX account you intend using in the real
deployment. If you get the message <code>stdin and stdout must not be a terminal</code>,
it means the configuration is valid and Crymap was ready to serve network
traffic.</p>
<p>We won’t create any users just yet.</p>
<h2 id="running-crymap-in-imaps-mode"><a class="header" href="#running-crymap-in-imaps-mode">Running Crymap in IMAPS mode</a></h2>
<p>Crymap does not run as a daemon. Instead, it uses a one-process-per-connection
model in which some other process listens for connections and spawns Crymap
processes as connections arrive. There are a number of options here, including
xinetd and systemd. Here, we will use traditional inetd, available as the
package <code>openbsd-inetd</code> on Debian and part of the base FreeBSD installation.</p>
<p>Arranging for Crymap to be run by inetd is just a matter of adding two lines to
<code>/etc/inetd.conf</code> and then restarting inetd:</p>
<pre><code class="language-text">imaps   stream  tcp     nowait  root    /usr/local/bin/crymap   crymap server serve-imaps
imaps	stream  tcp6    nowait  root    /usr/local/bin/crymap   crymap server serve-imaps
</code></pre>
<p>If setting up a simple black box deployment, replace <code>root</code> with whatever user
you want to run Crymap as.</p>
<p>Note the second occurrence of <code>crymap</code> in the command line is because inetd
requires the configuration to specify the usually implicit <code>argv[0]</code>
explicitly.</p>
<p>Do not add entries for the <code>imap4</code> service. Crymap does not support the
<a href="https://tools.ietf.org/html/rfc8314">obsolete</a> cleartext+<code>STARTTLS</code> mechanism
on the IMAP4 port 143.</p>
<p>To test whether this setup works, run <code>crymap remote test --trace --host=localhost</code>. (You can of course run from another system, in which case
pass the server’s host name to <code>--host</code>.) If successful, you should see some
IMAP protocol traces and receive a prompt for a password. Of course, since no
users have been created yet, it is not possible to log in, so simply cancel
once it gets that far.</p>
<h2 id="creating-a-user"><a class="header" href="#creating-a-user">Creating a User</a></h2>
<p>User creation is done with the <code>crymap server user add</code> command. By default, it
generates a random password for the new user; <code>--prompt-password</code> can be given
to input a password on the terminal instead. Refer to the <a href="user-guide.html">user
guide</a> to see how to change the password after the account has
been created.</p>
<p>On a UNIX-style setup, this command should be run as <code>root</code>, and you’ll usually
want to give the path to the user data explicitly.</p>
<pre><code class="language-text"># crymap server user add jsmith ~jsmith/crymap-mail
</code></pre>
<p>On a black box setup, this command should be run as the Crymap user, and if
your <code>users</code> directory is symlinked to a location outside of <code>/etc</code>, you can
leave the user directory off to simply store the user data inside <code>users</code>.</p>
<pre><code class="language-text">$ crymap server user add jsmith
</code></pre>
<p>With that done, you should be able to test logging in as the new user:</p>
<pre><code class="language-text">$ crymap remote test --host=localhost --user=jsmith
</code></pre>
<p>It is also possible at this point to connect your favourite email application
to Crymap, though you can’t receive email just yet.</p>
<h2 id="configuring-inbound-mail-delivery"><a class="header" href="#configuring-inbound-mail-delivery">Configuring Inbound Mail Delivery</a></h2>
<p>There are three ways to set up inbound mail delivery.</p>
<ul>
<li>
<p>SMTP. In this setup, Crymap receives messages directly from external servers.
Having Crymap handle SMTP directly is the simplest setup and ensures no
message data is written to disk in the clear, but is also the least flexible
option, as Crymap won’t do anything with inbound messages but deliver them to
the INBOX without flags.</p>
</li>
<li>
<p>LMTP. LMTP is a variant of SMTP which is suitable for the final step in the
mail delivery process. Compared to having Crymap serve SMTP directly, LMTP is
more complicated to set up as you need a third-party SMTP solution and may be
less secure since most SMTP servers spool messages to disk in cleartext, but
will give you whatever flexibility the SMTP solution offers. Compared to the
UNIX MDA option below, LMTP is robust, can correctly handle binary payloads,
and can be more efficient, but is inflexible in that all messages are
delivered to INBOX and without flags.</p>
</li>
<li>
<p>UNIX MDA. This is more flexible than SMTP LMTP as it can be made to deliver
to arbitrary mailboxes in a user’s account and to set flags on new messages.
In traditional UNIX setups, users can also invoke Crymap in as an MDA from
their <code>.forward</code> file. Its main disadvantages are that it is less robust
against errors, and because UNIX MDAs are typically passed the message with
all line endings converted to UNIX line endings, Crymap must convert the line
endings back, which will destroy binary content. Like LMTP, this also comes
with the disadvantages of needing an external SMTP solution.</p>
</li>
</ul>
<h3 id="smtp"><a class="header" href="#smtp">SMTP</a></h3>
<p>First, inbound SMTP requires a bit of extra configuration in <code>crymap.toml</code>.
You’ll need to tell Crymap what its fully-qualified domain name is and what
domains it is expecting to serve.</p>
<p>The below example shows what you might add to a server that will be receiving
email from <code>example.com</code> and <code>example.net</code>.</p>
<pre><code class="language-toml">[smtp]
# A DNS lookup for this name should return the IP address of the Crymap server.
host_name = "mx.example.net"

[smtp.domains."example.com"]
# No configuration here for now, we just need to make sure the section for
# "example.com" exists.

[smtp.domains."example.net"]
# No configuration here for now, we just need to make sure the section for
# "example.com" exists.
</code></pre>
<p>Next, you just need to arrange for Crymap to handle inbound SMTP connections.
Here is an example inetd configuration for a UNIX-style deployment:</p>
<pre><code class="language-text">smtp    stream  tcp     nowait  root    /usr/local/bin/crymap   crymap server serve-smtpin
smtp	stream  tcp6    nowait  root    /usr/local/bin/crymap   crymap server serve-smtpin
</code></pre>
<p>Notes:</p>
<ul>
<li>
<p>Notice this uses <code>serve-smtpin</code> instead of <code>serve-imaps</code> at the end.</p>
</li>
<li>
<p>As with IMAPS, for a simple black box deployment, you would configure it to
run under the Crymap user and not <code>root</code>.</p>
</li>
</ul>
<p>You can use <code>socat</code> to see if SMTP is working:</p>
<pre><code class="language-text">$ socat STDIO TCP:localhost:25
220 mx.example.net crymap 2.0.0 ESMTP ready
^C
</code></pre>
<p>At this point, you should also be able to send email from external email
providers to your server.</p>
<h3 id="lmtp"><a class="header" href="#lmtp">LMTP</a></h3>
<p>Besides setting up crymap, this section also contains concrete examples of
using OpenSMTPD; if you are using a different SMTP daemon, you will need to
refer to its documentation.</p>
<p>First, we need to set something up to run Crymap in LMTP mode. This works
essentially the same as how we set up IMAPS, except here we <em>don’t</em> want the
server to be accessible to anyone in the world. There’s two ways to do that:</p>
<ul>
<li>
<p>Configure inetd, etc, to only listen on localhost.</p>
</li>
<li>
<p>Use a UNIX socket. This is what we do in this example, since it is possible
to set finer-grained permissions.</p>
</li>
</ul>
<p>Here is an example inetd configuration for a UNIX-style deployment:</p>
<pre><code class="language-text">:root:wheel:666:/var/run/lmtp.sock stream tcp nowait root /usr/local/bin/crymap crymap server serve-lmtp
</code></pre>
<p>Notes:</p>
<ul>
<li>
<p>Notice this uses <code>serve-lmtp</code> instead of <code>serve-imaps</code> at the end.</p>
</li>
<li>
<p><code>root:wheel</code> would be written <code>root:root</code> on typical Linux installations.</p>
</li>
<li>
<p>As with IMAPS, for a simple black box deployment, you would configure it to
run under the Crymap user and not <code>root</code>.</p>
</li>
<li>
<p>This example allows anyone with shell access to open the LMTP socket and
deliver mail (due to the <code>666</code> permission). To prevent that, you can give the
socket a different owner and less permissive permissions. But to start with,
it is probably best to keep it simple so there are fewer things to debug.</p>
</li>
</ul>
<p>Crymap has a number of configurable options for LMTP. The defaults are fine for
simple installations, but you may want to have a look at the <a href="config-reference.html">configuration
reference</a>.</p>
<p>You can use <code>socat</code> to see if LMTP is working:</p>
<pre><code class="language-text">$ socat STDIO UNIX:/var/run/lmtp.sock
220 yourhostname crymap 2.0.0 LMTP ready
^C
</code></pre>
<p>Finally, you need to configure your SMTP server to deliver mail through LMTP.
For OpenSMTPD, your <code>smtpd.conf</code> file might contain something like this:</p>
<pre><code class="language-text">action "local_mail" lmtp "/var/run/lmtp.sock"
match from any for domain "lin.gl" action "local_mail"
match for local action "local_mail"
</code></pre>
<p>After that, all that’s left to test is to send the user an email and see if it
shows up!</p>
<h3 id="unix-mda"><a class="header" href="#unix-mda">Unix MDA</a></h3>
<p>There isn’t anything Crymap-specific to set up for this use case. You will need
to find out how to get your SMTP solution to run a UNIX MDA command line, which
in most cases would simply be <code>crymap server deliver</code>. Refer to
<code>crymap server deliver --help</code> for additional options.</p>
<h2 id="outbound-smtp"><a class="header" href="#outbound-smtp">Outbound SMTP</a></h2>
<p>If you want to use a third-party solution for outbound mail, there is nothing
to configure which is Crymap-specific. Third-party solutions are generally more
user-friendly, more battle-tested, and more flexible, but are less secure since
they need to spool messages onto disk in cleartext or another way that allows
passive recovery of the message content.</p>
<p>Crymap does have outbound SMTP support. Its advantages are simple
configuration, built-in DKIM support, unification of the authentication system
with IMAP, and that messages do not get spooled to disk in the clear. However,
it has a major downside: Retrying failed messages is <strong>manual</strong>, and currently
can only be done with the Crymap <strong>command-line application</strong>.</p>
<p>If you want to use Crymap’s outbound SMTP support, you will first need to add
the SMTP configuration to <code>crymap.toml</code> if you haven’t done this already. Refer
to the <a href="#SMTP">SMTP</a> section for an example.</p>
<p>If you have existing DKIM keys you wish to continue using, you can add these to
the domain-specific sections in <code>crymap.toml</code>. Search for “DKIM” in the
<a href="admin-guide/config.html">Configuration Guide</a> for details on what to add there.
You can use the <code>openssl</code> and <code>base64</code> command-line utilities to convert the
private keys you already have into the required format.</p>
<p>If you do not have existing DKIM keys, the next step will help you generate
some.</p>
<p>You can use <code>crymap server smtp-out-sanity-check</code> on your server to check your
configuration, including external DNS. This tool will generate DKIM keys for
you if you have none, and will provide additional suggestions to make it more
likely that major email providers will accept your email.</p>
<p>Finally, you need to arrange for Crymap to run SMTP submission to receive
outbound mail from your users. There are two supported options here:</p>
<ul>
<li>
<p>SMTP+TLS on port 465, called variously <code>submissions</code>, <code>smtps</code>, or <code>ssmtp</code> in
<code>/etc/services</code>, is preferred. Use only this one if you can. This is the
<code>serve-smtpssub</code> subcommand (note the double “s”).</p>
</li>
<li>
<p>SMTP submission on port 587, usually called <code>submission</code> in <code>/etc/services</code>.
This variant relies on the client performing <code>STARTTLS</code> and may be vulnerable
to the “strip TLS” attack depending on the client. This is the
<code>serve-smtpsub</code> (note no double “s”).</p>
</li>
</ul>
<p>Here is an example inetd configuration for a UNIX-style deployment with both protocols:</p>
<pre><code class="language-text"># The preferred "implicit TLS" variant
submissions stream  tcp     nowait  root    /usr/local/bin/crymap   crymap server serve-smtpssub
submissions stream  tcp6    nowait  root    /usr/local/bin/crymap   crymap server serve-smtpssub
# The legacy STARTTLS variant
submission  stream  tcp     nowait  root    /usr/local/bin/crymap   crymap server serve-smtpsub
submission  stream  tcp6    nowait  root    /usr/local/bin/crymap   crymap server serve-smtpsub
</code></pre>
<p>Notes:</p>
<ul>
<li>
<p>Sotice this uses <code>serve-smtpssub</code> and <code>serve-smtpsub</code> instead of
<code>serve-imaps</code> at the end.</p>
</li>
<li>
<p>As with IMAPS, for a simple black box deployment, you would configure it to
run under the Crymap user and not <code>root</code>.</p>
</li>
</ul>
<p>You can use <code>socat</code> to see if it is working:</p>
<pre><code class="language-text"># Implicit TLS protocol
# You could also use your server's fully-qualified domain name instead of
# "localhost" and then exclude ",verify=0" instead.
$ socat STDIO SSL:localhost:465,verify=0
220 mx.example.net crymap 2.0.0 ESMTPS ready
^C
# Legacy STARTTLS protocol
$ socat STDIO TCP:localhost:587
220 mx.example.net crymap 2.0.0 ESMTP ready
^C
</code></pre>
<p>You are now ready to test sending mail. You should start by emailing yourself
so that bad configuration does not impact your reputation on the big providers,
then move on to various third parties.</p>
<p>If sending a message fails at the SMTP level, the failure receipt will be
delivered to your account’s inbox, which you can use to debug why the remote
server rejected your message.</p>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<p>By default, Crymap logs to syslog under the “mail” utility. When Crymap is not
run from a terminal, this means its logs should end up someplace like
<code>/var/log/maillog</code> or <code>/var/log/mail.log</code>.</p>
<p>In certain cases of severe misconfiguration (for example, by passing invalid
parameters in <code>inetd.conf</code>), Crymap may instead print an error on standard
error and exit. Where these messages end up depends on what you are using to
run Crymap. The output might be in a system log like <code>/var/log/messages</code>, or it
could be getting sent over the socket. To check for the latter case, you can
run a command like <code>socat STDIO TCP:localhost:993</code> to see if anything shows up.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="encryption.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="admin-guide/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a href="encryption.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a href="admin-guide/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
