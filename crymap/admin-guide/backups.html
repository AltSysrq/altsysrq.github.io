<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Backups and Recovery - Crymap</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Usage documentation for the Crymap IMAP server">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "../";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'visible';
            if (document.body.clientWidth < 500) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../encryption.html"><strong aria-hidden="true">1.</strong> How Crymap's Encryption Works</a></li><li class="chapter-item expanded "><a href="../installation-guide.html"><strong aria-hidden="true">2.</strong> Installation Guide</a></li><li class="chapter-item expanded "><a href="../admin-guide/index.html"><strong aria-hidden="true">3.</strong> Administration Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../admin-guide/config.html"><strong aria-hidden="true">3.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../admin-guide/users.html"><strong aria-hidden="true">3.2.</strong> Managing Users</a></li><li class="chapter-item expanded "><a href="../admin-guide/backups.html" class="active"><strong aria-hidden="true">3.3.</strong> Backups and Recovery</a></li><li class="chapter-item expanded "><a href="../admin-guide/filesystem.html"><strong aria-hidden="true">3.4.</strong> Understanding the Filesystem</a></li><li class="chapter-item expanded "><a href="../admin-guide/tuning.html"><strong aria-hidden="true">3.5.</strong> Tuning</a></li></ol></li><li class="chapter-item expanded "><a href="../user-guide.html"><strong aria-hidden="true">4.</strong> User Guide</a></li><li class="chapter-item expanded "><a href="../imap.html"><strong aria-hidden="true">5.</strong> IMAP Characteristics</a></li><li class="chapter-item expanded "><a href="../lmtp.html"><strong aria-hidden="true">6.</strong> LMTP Characteristics</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Crymap</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#backups-and-recovery" id="backups-and-recovery">Backups and Recovery</a></h1>
<h2><a class="header" href="#backups" id="backups">Backups</a></h2>
<p>Crymap uses a “filesystem as a database” model for its storage. This means that
no exotic tooling is required to back the Crymap data up. Even simple tools
such as <code>rsync</code> are sufficient.</p>
<p>A proper backup system should be able to handle the following:</p>
<ul>
<li>Binary file content</li>
<li>Unicode file names</li>
<li>Symlinks must be backed up as symlinks, not copies of what they point to, and
must retain their exact target</li>
<li>Cyclic and dangling symlinks must be tolerated</li>
</ul>
<p>Exact file modes and owners do not need to be preserved, but it is better if
they are. While Crymap creates hard links, it does not require them to be
preserved, and a backup will function properly if the hard-linked files are
reconstructed as separate files. Crymap does not use file timestamps or
extended attributes for anything important.</p>
<p>Crymap is designed to be tolerant of anomalies resulting from the backup
process not capturing an atomic snapshot of the user data directory. There is
one requirement: the backup system must be able to process the a user’s whole
data directory in less than 24 hours. If this requirement is met, no data which
existed before the backup started will be lost, with one corner case.</p>
<p>The corner case is has to do with mailbox renaming, since Crymap uses
filesystem directories to model the mailbox hierarchy. Consider a user with the
below mailbox hierarchy.</p>
<pre><code class="language-text">|-+ INBOX
|
|-+ In Progress
| |
| \-+ TPS Reports
|
\-+ Archive
</code></pre>
<p>It might happen that the backup system happens to process these directories in
this order: <code>Archive</code>, <code>INBOX</code>, <code>In Progress</code>. When it goes through <code>Archive</code>,
it makes a backup in which <code>Archive</code> has no child mailboxes. Now, suppose that
when it is working on <code>INBOX</code>, the user moves <code>TPS Reports</code> into <code>Archive</code>:</p>
<pre><code class="language-text">|-+ INBOX
|
|-+ In Progress
|
\-+ Archive
  |
  \-+ TPS Reports
</code></pre>
<p>Now, when the backup system finishes <code>INBOX</code> and moves on to <code>In Progress</code>, it
makes a backup of <code>In Progress</code> which has no child mailboxes. Now we have a
backup which does not contain <code>TPS Reports</code> anywhere, even though that mailbox
always existed somewhere!</p>
<p>This is a problem inherent in any filesystem-based backup system, and means it
is important to have multiple backups available in case one backup runs at just
the wrong time.</p>
<p>This corner case does not affect moving individual messages between mailboxes
because Crymap is able to retain the messages in their old location for the
24hr grace period.</p>
<h2><a class="header" href="#restoring-from-backup" id="restoring-from-backup">Restoring from Backup</a></h2>
<p>Due to the “filesystem as a database” model, restoring from backup is usually
just a matter of recovering the files and putting them back in the correct
place, possibly after fixing permissions if the backup system does not preserve
them.</p>
<p>If the backup is not a fully consistent state, mail applications may have
difficulty resynchronising. It may be necessary to do a “repair” or fully
reconfigure the application.</p>
<p>It is also possible to retrieve parts of a user’s account (i.e. mailboxes) and
insert them into the current account by placing the directories in an
appropriate place under the <code>mail</code> directory within the user data directory. If
there are missing RSA keys, they can also be retrieved from the <code>keys</code>
directory in the backup and added to the current filesystem. No special
configuration or notification to Crymap is needed for these operations; simply
putting the files/directories into place is sufficient.</p>
<p>Objects from a user account are readable from only that user account. For
example, in case of a system failure, you cannot set up a new system, create
user accounts in it, and then expect to be able to drop data from the backups
into those new user accounts. The user accounts themselves must be restored
from backup.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../admin-guide/users.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../admin-guide/filesystem.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../admin-guide/users.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../admin-guide/filesystem.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
